
## RDB（Redis Database Backup file）

**RDB：就是把内存中的所有数据都记录到磁盘中，当redis实例故障重启后，从磁盘读取快照文件，恢复数据。**

#### RDB 的工作原理
- **自动保存：** Redis 会定期根据配置（如 save 配置项）创建快照。
- **手动保存：** 使用 BGSAVE 命令可以手动触发 Redis 创建快照。
- **保存过程：** Redis 在后台使用 fork() 创建一个子进程，子进程会将数据写入到 RDB 文件中。主进程继续提供服务，不会被阻塞。
#### 执行`BGSAVE`命令时的过程

1. **父进程（主进程）**：
    - Redis 在接收到 BGSAVE 命令后，主进程会通过 fork() 创建一个子进程。
    - **父进程继续运行**，它保持对客户端的响应能力，处理写请求和读请求。
    - 
2. **子进程（快照进程）**：
    - **子进程从父进程复制内存**，开始生成 Redis 数据库的 RDB 快照文件。
    - **子进程读取父进程的内存数据**，并将其写入到磁盘上的 RDB 文件中。
    
3. **共享内存与写时复制（COW）**：
    - 在 fork() 后，**父进程和子进程最初共享相同的内存**，即它们都有对同一块内存的访问权限。
    - 当父进程收到客户端请求并进行 **写操作**（例如，设置一个键值对），操作系统会为父进程修改的数据创建一个 **独立的副本**。
    - **子进程不会看到这些修改**，因为它使用的是父进程在 fork() 时复制的原始数据，而父进程的修改数据存在新的副本中。
    
4. **内存副本的创建**：
    - 具体来说，如果父进程修改了某些数据（比如更新一个键的值），操作系统会 **为父进程的数据创建副本**，并将修改后的数据写入这个副本。
    - 子进程则继续使用 **原始的、未被修改的数据** 来生成快照，因此子进程的内存不会受到影响。
## AOF（Append-Only File）

**AOF是另一种持久化机制，它通过记录每一个写操作（命令）来持久化数据。每次写入命令都会被追加到 AOF 文件中，Redis 可以通过重放 AOF 文件中的命令来恢复数据。**

1. **AOF 的工作原理：**
	- 每次客户端执行写操作时，Redis 会将该操作以文本的形式追加到 AOF 文件中。
	- AOF文件比RDB文件大的多，而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。所以Redis 会周期性地重写 AOF 文件（`BGREWRITEAOF`），以避免 AOF 文件过大。
	- 当 Redis 启动时，它会读取 AOF 文件并重放其中的命令来恢复数据。

2. **持久化方式**：AOF 支持三种不同的 appendfsync 策略来控制数据刷写到磁盘的频率：
    - `appendfsync always`：每次写命令执行后，都将其立即写入磁盘。
    - `appendfsync everysec`：每秒写一次，这通常是默认的设置，它会将写命令批量保存到磁盘，减少磁盘 I/O 操作。
    - `appendfsync no`：不自动刷盘，需要手动触发数据刷写。

### RDB和AOF的对比

| 特性          | RDB 持久化                   | AOF 持久化                      |
| ----------- | ------------------------- | ---------------------------- |
| **数据持久化方式** | 通过生成数据快照来持久化数据            | 通过记录每个写操作命令来持久化数据            |
| **性能影响**    | 性能影响较小，因为只在生成快照时进行 I/O    | 会对性能产生较大影响，尤其是在频繁写入时         |
| **数据恢复速度**  | 恢复速度较快                    | 恢复速度较慢，尤其是 AOF 文件较大的时候       |
| **数据丢失风险**  | 数据丢失风险较高，可能丢失最近一次快照后的数据   | 数据丢失风险较低，除非最后写操作没有被写入 AOF 文件 |
| **内存消耗**    | 内存消耗较低，快照文件较小             | 内存消耗较高，因为需要存储每个写操作的命令        |
| **配置简单度**   | 配置较简单，通常只需要设置 `save` 参数   | 配置相对复杂，需要配置 `appendfsync`    |
| **适用场景**    | 适用于对数据丢失容忍度较高的场景，且对性能要求较高 | 适用于需要精确恢复数据的场景，要求较高的持久化安全性   |
| **磁盘使用量**   | 相对较少，生成的 RDB 文件较小         | 较大，因为 AOF 会记录每一个写操作          |
| **重写机制**    | 无需重写，只有快照生成的过程            | 会定期进行 AOF 文件重写，避免文件过大        |
| **恢复方式**    | 通过加载快照文件恢复数据              | 通过重放 AOF 文件中的命令恢复数据          |
| **碎片问题**    | 不存在碎片化问题                  | 可能存在碎片化问题，尤其是在没有启用 AOF 重写时   |

- **RDB 持久化**：
    - 优点：生成快照时不会频繁写入磁盘，因此对性能影响较小；数据恢复速度较快，适合用作备份。
    - 缺点：数据丢失风险较高，可能会丢失最近一次快照之后的数据；无法实时记录数据变更。
- **AOF 持久化**：
    - 优点：可以记录每个写操作，数据丢失风险较低，且恢复数据精度高；适用于需要精确恢复的场景。
    - 缺点：对性能影响较大，特别是在频繁写入时；AOF 文件会随着时间增大，需要定期重写。
