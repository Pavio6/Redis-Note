
## 全量同步
全量同步是 Redis 主从复制中的 **初次同步** 过程。当一个从节点首次连接到主节点时，主节点会将所有的数据库内容 **完整地** 传输给从节点，确保从节点的副本与主节点一致。
#### 全量同步的过程
- slave节点请求增量同步
- master节点判断replid，发现不一致，拒绝增量同步
- master将完整内存数据生成RDB，发送RDB到slave
- slave清空本地数据，加载master的RDB
- master将RDB期间的命令记录在repl_baklog，并持续将log中的命令发送给slave
- slave执行接收到的命令，保持与master之间的同步

> **如何判断是初次同步呢？**

在 Redis 主从复制中，从节点通过 PSYNC 命令与主节点进行同步。
主节点会检查 PSYNC 请求中的 **复制偏移量** 和 **复制 ID**。
- 如果复制偏移量有效且复制 ID 与主节点一致，主节点会执行 **增量同步**。
- 如果复制偏移量无效或复制 ID 不一致，主节点会执行 **全量同步**。
## 增量同步

增量同步是在全量同步完成之后的一个过程，用于保持主节点和从节点之间的 **数据一致性**。在增量同步中，从节点只会同步主节点的 **数据变动**，而不是每次都传输整个数据集。
#### 增量同步的过程
- slave提交自己的offset到master
- master获取repl_baklog中从offset之后的命令给slave

增量同步的关键点是 **命令传播**。主节点发送的数据是对数据的 **增量操作**，而不是整个数据集。

#### 增量同步执行时机：
1. slave节点断开又恢复时，并且在repl_baklog中能找到offset时
2. 从节点首次连接时，主节点会通过全量同步（生成 RDB 快照）将数据传输给从节点。全量同步完成后，增量同步会开始进行。

#### 增量同步的优缺点

- **优点**：增量同步只传递变化的数据，因此在数据变动较小的情况下，网络带宽的消耗会更少，性能也会更好。它不会阻塞主节点的写操作，适用于高性能、高并发的场景。
- **缺点**：如果从节点和主节点的连接断开较长时间，增量同步会丢失连接期间的所有变更数据。因此，在这种情况下，从节点需要重新进行 **全量同步**，恢复数据一致性。